---
title: "Validate Submission"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Validate Submission}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The `covid19SMHvalidation` R package contains functions to pull data from the 
R package covidcast (output in the Scenario Modeling Hub (SMH) standard format),
to validate and visualize Scenario Modeling Hub submission.

In this vignette, we will show how to use the validation function: 
`validate_submision()`. The function can generate 3 different outputs:

 * message when the submission does not contain any issues
 * warning + report message when the submission does contain one or multiple 
 minor issues that do not prevent the submission to be included.
 * error + report message when the submission does contain one or multiple 
 minor and/or major issues that prevent the submission to be included. In this 
 case the submission file will have to be updated to be include in the \
 corresponding SMH round. 

We will start by loading `covid19SMHvalidation`:

```{r setup}
library(covid19SMHvalidation)
```

## `validate_submission()`

To run the SMH validation checks, we can use the `validate_submision()` 
function. For more information on this function, please consult the 
documentation

```{r}
?validate_submission()
```

For more information on all the tests the function perform, please consult the
vignette [Validation Checks](validation-checks.html).

#### Parameters

The function requires multiple parameters:

* `path`: path to the submission files. The package contains 3 examples files 
that can be used to test the function. There paths can be accessed by using: 
`system.file("extdata", "FILENAME", package = "covid19SMHvalidation")`. the
3 filenames (+ quick descriptions) are:
    * "2022-01-09_team-model.csv" : should returns no issues
    * "2021-08-15_team-model.gz" : should returns multiple warnings
    * "2021-11-14_team-model.zip" : should returns multiple warnings and errors
* `lst_gs`: named list of data frame containing the observed data. 
We highly recommend to use the output of the `pull_gs_data()` function as input.
This function will generate the output in the expected format with the expected 
data. For more information, please do `?pull_gs_data()`. This parameter can be 
set to `NULL` is no observed data comparison is required. 
* `pop_path`: path to a table containing the population size of each 
geographical entities by FIPS (in a column "location") and by location name. 
For example, path to the locations file in the 
[COVID19 Scenario Modeling Hub GitHub repository](https://github.com/midas-network/covid19-scenario-modeling-hub/blob/master/data-locations/locations.csv)
* `js_def`: list containing the round specific and scenario information. It 
should be in the same output format as the function `json_metadata()` in the
package `ScenarioModelingHub.data`. Some examples are also available in this 
package.

#### Output

The function returns multiple messages and either a warning message or an error
message if the submission contains minor issues and/or majors issues 
respectively. 
If the submission contains minor and/or major issue(s), it will also returns
a "report" message containing a detailed message about the issue and if the
issue is:

* "minor": warning message asking to verify if it's correct but will not block
the inclusion of the submission to the SMH round.
* "major": error message asking to fix the issue before including the submission
in the corresponding SMH round.

#### Prerequisite

Before running the function, we will prepare the required and optional parameter
as explained above:

```{r prerequisite, message=FALSE, warning=FALSE}
lst_gs <- pull_gs_data()
pop_path <- "https://raw.githubusercontent.com/midas-network/covid19-scenario-modeling-hub/master/data-locations/locations.csv"
js_def <- system.file("extdata", "2022-01-09_metadata.json", package = "covid19SMHvalidation")
#js_def <- jsonlite::fromJSON(js_def)
```

To look at the structure of `lst_gs` and `js_def`:

```{r str}
str(lst_gs)
str(js_def)
```

## Example 1: No issues

We can now run the `validate_submission()` function on a first example file.

```{r test1}
path_test <- system.file("extdata", "2022-01-09_team-model.csv", package = "covid19SMHvalidation")
validate_submission(path_test, lst_gs, pop_path, js_def)
```

The function returns a simple message stating that no issues has been found.

## Example 2: Warnings

```{r test2}
path_test <- system.file("extdata", "2021-08-15_team-model.gz", package = "covid19SMHvalidation")
js_def <- system.file("extdata", "2021-08-15_metadata.json", package = "covid19SMHvalidation")
#js_def <- jsonlite::fromJSON(js_def)
validate_submission(path_test, lst_gs, pop_path, js_def)
```

The function returns a warning message stating that one or multiple issues 
has been found.

The submission will still be accepted but please verify that the information
in the submission is correct. 

## Example 3: Warnings & Error

```{r test3, error=TRUE}
path_test <- system.file("extdata", "2021-11-14_team-model.zip", package = "covid19SMHvalidation")
js_def <- system.file("extdata", "2021-11-14_metadata.json", package = "covid19SMHvalidation")
#js_def <- jsonlite::fromJSON(js_def)
validate_submission(path_test, lst_gs, pop_path, js_def)
```

The function returns an error message stating that one or multiple issues 
has been found.

The submission will NOT be accepted and need correction before being accepted.

## Example 4: Flu submission

```{r test4}
path_test <- system.file("extdata", "2022-08-14_team-flu.csv", package = "covid19SMHvalidation")
pop_path <- "https://raw.githubusercontent.com/midas-network/flu-scenario-modeling-hub/main/data-locations/locations.csv"
js_def <- system.file("extdata", "2022-08-14_metadata.json", package = "covid19SMHvalidation")
#js_def <- jsonlite::fromJSON(js_def)
validate_submission(path_test, NULL, pop_path, js_def)
```


## Plotting Projections

The `covid19SMHvalidation` R package also contains plotting functionality to 
output a plot of each location and target, with all scenarios and observed data 
incorporated.

```{r proj_plots}
path_test <- system.file("extdata", "2022-01-09_team-model.csv", package = "covid19SMHvalidation")
save_path <- getwd()
pdf_path <- file.path(save_path, paste0("2022-01-09", "_", "team-model", "_plots.pdf"))
print(paste0("Saving pdf plots to ", pdf_path, "."))
generate_validation_plots(path_proj=path_test, lst_gs=lst_gs, save_path=getwd(), y_sqrt = FALSE, plot_quantiles = c(0.025, 0.975))
system(paste0('open "', pdf_path, '"'))
```

Try another file type (CSV, GZ, and ZIP files format are accepted currently)

```{r proj_plots2}
path_test <- system.file("extdata", "2021-08-15_team-model.gz", package = "covid19SMHvalidation")
save_path <- getwd()
pdf_path <- file.path(save_path, paste0("2021-08-15", "_", "team-model", "_plots.pdf"))
print(paste0("Saving pdf plots to ", pdf_path, "."))
generate_validation_plots(path_proj=path_test, lst_gs=lst_gs, save_path=getwd(), y_sqrt = FALSE, plot_quantiles = c(0.025, 0.975))
system(paste0('open "', pdf_path, '"'))
```

An other example is available for FLU submission (not compared to observed 
data, set the `lst_gs` parameter to `NULL`)

```{r proj_plots3}
path_test <- system.file("extdata", "2022-08-14_team-flu.csv", package = "covid19SMHvalidation")
save_path <- getwd()
pdf_path <- file.path(save_path, paste0("2022-08-14", "_", "team-flu", "_plots.pdf"))
print(paste0("Saving pdf plots to ", pdf_path, "."))
generate_validation_plots(path_proj=path_test, lst_gs=NULL, save_path=getwd(), y_sqrt = FALSE, plot_quantiles = c(0.025, 0.975))
system(paste0('open "', pdf_path, '"'))
```



